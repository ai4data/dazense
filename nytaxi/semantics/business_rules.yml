rules:
    # === DATA QUALITY ===

    - name: cash_tips_not_recorded
      category: data_quality
      severity: critical
      applies_to: [trips.total_tips, trips.avg_tips]
      description: Cash tips are not recorded electronically
      guidance: >
          tip_amount is only reliable for credit card payments (payment_type = 1).
          Cash payments (payment_type = 2) show tip_amount = 0, which does not
          mean no tip was given. Always caveat tip analysis with this fact.
          To analyze tips accurately, filter to credit card payments only.

    - name: unknown_zones
      category: data_quality
      severity: warning
      applies_to: [zones]
      description: Some location IDs map to Unknown zones
      guidance: >
          Location IDs 264 and 265 correspond to "Unknown" zones. Filter these
          out for borough-level or zone-level analysis unless explicitly included.

    - name: passenger_count_quality
      category: data_quality
      severity: warning
      applies_to: [trips.passenger_count]
      description: Passenger count is driver-entered and may be inaccurate
      guidance: >
          Passenger count is manually entered by the driver. Values of 0 are
          common and likely erroneous. Filter passenger_count > 0 for analysis.

    # === METRIC DEFINITIONS ===

    - name: disputed_trips_excluded_from_revenue
      category: metrics
      severity: critical
      applies_to: [trips.total_revenue, trips.total_fare, trips.avg_fare, trips.avg_revenue]
      description: Revenue and fare metrics should exclude disputed and voided trips
      guidance: >
          Always filter out payment_type = 4 (dispute) and payment_type = 5 (voided)
          when computing revenue or fare metrics. These represent trips where the
          passenger contested the charge or the trip was cancelled.

    - name: standard_rate_for_benchmarking
      category: metrics
      severity: warning
      applies_to: [trips.avg_fare, trips.avg_trip_distance]
      description: Average fare and distance are most meaningful for standard rate trips
      guidance: >
          For fare benchmarking, filter to rate_code_id = 1 (Standard rate) to
          exclude flat-rate trips (JFK=$52, Newark=negotiated) that skew averages.

    # === DOMAIN KNOWLEDGE ===

    - name: airport_trips
      category: domain
      severity: info
      applies_to: [zones, trips.total_fare, trips.avg_fare]
      description: Airport zones have special fare rules
      guidance: >
          JFK (location_id 132) has a flat rate of $52 to/from Manhattan (rate_code_id = 2).
          Newark (location_id 1) uses a negotiated fare (rate_code_id = 3).
          LaGuardia (location_id 138) uses the standard metered rate.
          When analyzing airport trips, break down by airport and rate code.

    - name: borough_trip_patterns
      category: domain
      severity: info
      applies_to: [zones.borough, trips.avg_fare, trips.avg_tips, trips.avg_trip_distance]
      description: Trip characteristics vary systematically by borough
      guidance: >
          Manhattan: highest trip volume, shortest distances, highest tip rates (tourist/business).
          Queens: high airport transfer volume (JFK, LaGuardia), longer average distances.
          Brooklyn: growing demand, mix of local and Manhattan-bound trips.
          Bronx: lower taxi demand, longer trips when they occur.
          Staten Island: very low taxi usage, mostly car-dependent.

    - name: time_of_day_patterns
      category: domain
      severity: info
      applies_to: [trips.pickup_datetime, trips.trip_count]
      description: Demand follows predictable daily and weekly patterns
      guidance: >
          Rush hours (7-9 AM, 5-7 PM weekdays): commute-dominated, higher volume, congestion.
          Late night (10 PM - 4 AM): entertainment trips, higher tips from bars/restaurants.
          Weekends: later morning peak, tourist and leisure dominated.
          When comparing metrics across time, account for these volume differences.

    - name: tip_variation_by_context
      category: domain
      severity: info
      applies_to: [trips.avg_tips, trips.total_tips]
      description: Tips vary systematically by trip context — not just service quality
      guidance: >
          Manhattan tips are 40-50% higher than outer boroughs (tourists, business travelers).
          Airport trips typically see 15-20% tip rate. Local trips see 10-15%.
          Evening entertainment trips tip higher than daytime commute trips.
          Do NOT interpret low tips in outer boroughs as a service quality problem —
          always compare within similar trip types, not across boroughs.

classifications:
    airport_trip:
        description: 'Trip starting or ending at an airport zone'
        condition: 'ratecode_id IN (2, 3) OR pu_location_id IN (1, 132, 138)'
        tags: [zone, fare, tip]
        characteristics:
            expected_tip_rate: '15-20%'
            flat_rate: 'JFK has $52 flat rate to Manhattan (ratecode_id = 2)'
            negotiated_fare: 'Newark uses negotiated fare (ratecode_id = 3)'
            common_zones: 'JFK (132), Newark (1), LaGuardia (138)'

    commute_trip:
        description: 'Weekday rush-hour trip typical of work commuters'
        condition: 'EXTRACT(DOW FROM pickup_datetime) BETWEEN 1 AND 5 AND (EXTRACT(HOUR FROM pickup_datetime) BETWEEN 7 AND 9 OR EXTRACT(HOUR FROM pickup_datetime) BETWEEN 17 AND 19)'
        tags: [time, zone, fare]
        characteristics:
            peak_hours: '7-9 AM and 5-7 PM on weekdays'
            typical_distance: 'Short to medium (1-5 miles)'
            tip_behavior: 'Lower tip rates than leisure trips (10-15%)'
            congestion: 'Higher congestion surcharges during rush hours'

    night_trip:
        description: 'Late-night trip, often entertainment or bar-related'
        condition: 'EXTRACT(HOUR FROM pickup_datetime) >= 22 OR EXTRACT(HOUR FROM pickup_datetime) < 4'
        tags: [time, tip, fare]
        characteristics:
            time_range: '10 PM to 4 AM'
            tip_behavior: 'Higher tips than daytime (15-25%), especially bar/restaurant trips'
            surcharge: '$0.50 overnight surcharge applies (8 PM - 6 AM)'
            demand_pattern: 'Peaks around midnight on weekends'

    long_distance_trip:
        description: 'Trip with above-average distance, often inter-borough or to airports'
        condition: 'trip_distance > 10'
        tags: [fare, zone, distance]
        characteristics:
            typical_fare: 'Significantly higher than average ($30+)'
            common_routes: 'Manhattan to airports, inter-borough transfers'
            trip_duration: 'Usually 30+ minutes depending on traffic'
            rate_type: 'May use flat rate (airports) or metered rate'
