services:
    postgres:
        image: postgres:16-alpine
        container_name: dazense_chat_postgres
        env_file:
            - .env
        environment:
            POSTGRES_USER: ${POSTGRES_USER:-dazense}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-dazense}
            POSTGRES_DB: ${POSTGRES_DB:-dazense}
        ports:
            - '8888:5432'
        volumes:
            - dazense_postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-dazense} -d ${POSTGRES_DB:-dazense}']
            interval: 5s
            timeout: 5s
            retries: 5

    dazense:
        build:
            context: .
            dockerfile: Dockerfile
        ports:
            - '5005:5005'
        environment:
            # =================================================================
            # Authentication & API Keys
            # =================================================================
            BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
            OPENAI_API_KEY: ${OPENAI_API_KEY}
            ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}

            # =================================================================
            # Slack Integration (optional)
            # =================================================================
            SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
            SLACK_SIGNING_SECRET: ${SLACK_SIGNING_SECRET}

            # =================================================================
            # Database for dazense chat history
            # =================================================================
            DB_URI: postgres://${POSTGRES_USER:-dazense}:${POSTGRES_PASSWORD:-dazense}@postgres:5432/${POSTGRES_DB:-dazense}

            # =================================================================
            # Context Configuration
            # =================================================================
            # Option A: Local mode (default) - uses bundled example or volume mount
            DAZENSE_CONTEXT_SOURCE: local
            DAZENSE_DEFAULT_PROJECT_PATH: /app/example

            # Option B: Git mode - uncomment and configure these instead:
            # DAZENSE_CONTEXT_SOURCE: git
            # DAZENSE_CONTEXT_GIT_URL: https://github.com/your-org/your-dazense-context.git
            # DAZENSE_CONTEXT_GIT_BRANCH: main
            # DAZENSE_CONTEXT_GIT_TOKEN: ${GITHUB_TOKEN}
            # DAZENSE_DEFAULT_PROJECT_PATH: /app/context

            # Optional: Schedule periodic git pull (cron expression)
            # DAZENSE_REFRESH_SCHEDULE: "0 * * * *"  # Every hour
        volumes:
            - ${DAZENSE_DEFAULT_PROJECT_PATH}:/app/example
        depends_on:
            - postgres

volumes:
    dazense_postgres_data:
