# =============================================================================
# Docker Compose for Git-based Context
# =============================================================================
# This example shows how to deploy dazense with context loaded from a git repository.
# No volume mount is required - the container clones the context on startup.
#
# Usage:
#   docker-compose -f docker-compose.git-context.yml up -d
#
# Prerequisites:
#   1. Create a git repo with your dazense context (dazense_config.yaml, databases/, etc.)
#   2. Set up CI/CD to run `dazense sync` and commit results
#   3. Create a .env file with your secrets
#
# =============================================================================

services:
    postgres:
        image: postgres:16-alpine
        container_name: dazense_chat_postgres
        environment:
            POSTGRES_USER: ${POSTGRES_USER:-dazense}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-dazense}
            POSTGRES_DB: ${POSTGRES_DB:-dazense}
        ports:
            - '8888:5432'
        volumes:
            - dazense_postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-dazense} -d ${POSTGRES_DB:-dazense}']
            interval: 5s
            timeout: 5s
            retries: 5

    dazense:
        build:
            context: .
            dockerfile: Dockerfile
        ports:
            - '5005:5005'
        environment:
            # =================================================================
            # Authentication & API Keys
            # =================================================================
            BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
            OPENAI_API_KEY: ${OPENAI_API_KEY}
            ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
            GOOGLE_APPLICATION_CREDENTIALS_JSON: ${GOOGLE_APPLICATION_CREDENTIALS_JSON}

            # =================================================================
            # Database for dazense chat history
            # =================================================================
            DB_URI: postgres://${POSTGRES_USER:-dazense}:${POSTGRES_PASSWORD:-dazense}@postgres:5432/${POSTGRES_DB:-dazense}

            # =================================================================
            # Git-based Context Configuration
            # =================================================================
            DAZENSE_CONTEXT_SOURCE: git
            DAZENSE_CONTEXT_GIT_URL: ${DAZENSE_CONTEXT_GIT_URL}
            DAZENSE_CONTEXT_GIT_BRANCH: ${DAZENSE_CONTEXT_GIT_BRANCH:-main}
            DAZENSE_CONTEXT_GIT_TOKEN: ${DAZENSE_CONTEXT_GIT_TOKEN}
            DAZENSE_DEFAULT_PROJECT_PATH: /app/context

            # Refresh context every hour (git pull)
            DAZENSE_REFRESH_SCHEDULE: '0 * * * *'
        depends_on:
            - postgres

volumes:
    dazense_postgres_data:
